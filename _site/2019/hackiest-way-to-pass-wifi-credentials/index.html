<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
 
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicons/favicon-96x96.png">
  <link rel="manifest" href="/assets/favicons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/favicons/ms-icon-144x144.png">
  <meta name="theme-color" content="#454545">

  <meta name="google-site-verification" content="unVLsLtZ5JXjvkqK1ir5mKJ-VcaC0fIocmj52TdsULg" />
  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" type="text/css" lazyload>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather|Ubuntu+Mono|Lato" rel="stylesheet" lazyload>
  <link rel="alternate" type="application/rss+xml" title="RSS Feed for polycarp - random notes on computer security" href="/feed.xml" />
  <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>The hackiest way I’ve seen to pass WiFi credentials to an IoT device | polycarp - random notes on computer security</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="The hackiest way I’ve seen to pass WiFi credentials to an IoT device" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Picture this: you just bought your brand new IoT device. You take it out from the box and power it on. But… how do you pass your WiFi credentials to make it connect to your network? This solution literally blew my mind!" />
<meta property="og:description" content="Picture this: you just bought your brand new IoT device. You take it out from the box and power it on. But… how do you pass your WiFi credentials to make it connect to your network? This solution literally blew my mind!" />
<link rel="canonical" href="http://localhost:4000/2019/hackiest-way-to-pass-wifi-credentials/" />
<meta property="og:url" content="http://localhost:4000/2019/hackiest-way-to-pass-wifi-credentials/" />
<meta property="og:site_name" content="polycarp - random notes on computer security" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-09-24T00:00:00+02:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2019/hackiest-way-to-pass-wifi-credentials/","description":"Picture this: you just bought your brand new IoT device. You take it out from the box and power it on. But… how do you pass your WiFi credentials to make it connect to your network? This solution literally blew my mind!","headline":"The hackiest way I’ve seen to pass WiFi credentials to an IoT device","dateModified":"2019-09-24T00:00:00+02:00","datePublished":"2019-09-24T00:00:00+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019/hackiest-way-to-pass-wifi-credentials/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  
  <meta name="keywords" content="iot, smart config, ap mode, esp8266, tuya, internet of things">
  

  

  <!-- Google Analytics -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130789124-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-130789124-1');
</script>




</head>

<body>
  <div class="content-container">
    <header>
  <div class="header-small">
    <a href="http://localhost:4000" target="_self"><img id="logo" src="http://localhost:4000/assets/images/logo.png" alt="logo"></a>
  </div>
  <nav class="header-nav">
    
    
    <a href="/" target="_self">Blog</a>
     &nbsp/&nbsp 
    
    
    
    <a href="/about/" target="_self">About</a>
    
    
    
  </nav>
</header>
<div class="page">
  <base target="_blank">

<div class="post">
  <h1 class="post-title">The hackiest way I've seen to pass WiFi credentials to an IoT device</h1>
  <span class="post-date">
    <time>24 Sep 2019</time>
  </span>
  <div class="post-tag">
    <ul>
      
    </ul>
  </div>

  <p>During the first startup of a new IoT device, users must be able to make it connect to them WiFi network. But, how it is possible to supply WiFi credentials to the device, if the device itself isn’t attached to anything?</p>

<p>Of course, the device can be shipped with some additional communication module (like Bluetooth or an ultrasound microphone) that will be used specifically to receive the network credentials. However, manufacturers may be interested in keeping production costs very low, so there’s interest in doing everything with just the WiFi module.</p>

<p>To address this problem, the most commonly adopted solution is <strong>AP mode</strong>.</p>

<p>Upon the startup, the device activates a software access point, along with a webserver and a DNS server. The user must disconnect from its home network and connect to the device AP. At this point, a setup webpage automatically appears, allowing the user to supply all the needed credentials. Once the credentials are sent, the device powers off its access point and connects itself to the home network. On the ESP8266, this can be implemented using the <a href="https://github.com/tzapu/WiFiManager">WiFiManager</a> library.</p>

<p>Even if relatively simple, the user is forced to change its WiFi network back and forth, which may be annoying. For this reason, a second, <strong>hacky and more interesting solution</strong> has been designed.</p>

<p><strong>Smart config</strong> does not even require the user to switch between the device AP and his home network, providing a seamless way to send WiFi credentials to IoT devices. 
This time, the device puts its network interface to <u>promiscous mode</u>, with the purpose of sniffing every packet transmitted nearby. On the other side, the user configuration app sends tons of UDP packets via broadcast in the home network, <u>encoding SSID and PSK</u> of the WiFi network <u>in the length field on each packet</u>. Indeed, while it is true that the content of those packets cannot be read from hosts that do not know which is the network passphrase (as our IoT device), the length field can be read with no hassle.</p>

<p>Tuya IoT devices implement this solution: we can take a look on the relative <a href="https://github.com/TuyaAPI/link/blob/master/lib/link.js">API</a> to understand how does it work. 
The protocol starts with the transmission of a preamble sequence, i.e. a series of UDP packets that carry, in their length field, a recognisable pattern (1,3,6,10). This helps the IoT device to filter out which device is supposed to send useful data, by looking at the source MAC address. Then, the actual data is sent over multiple UDP packets, as the length field can hold up to 2 bytes of data.</p>

<p>Here you can find some interesting material:</p>

<ul>
  <li><a href="https://www.espressif.com/sites/default/files/30b-esp-touch_user_guide_en_v1.1_20160412_0.pdf">Documentation for the ESP8266</a></li>
  <li><a href="https://github.com/ct-Open-Source/tuya-convert/tree/master/scripts/smartconfig">Python script </a></li>
</ul>




</div>

</div>


    
<div class="footer">
  <hr />
  <div class="footer-link">
    
	
	
	
	

    
    <a href="https://twitter.com/surruskij" target="_blank"><img alt="twitter" class="social-icons" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDU2LjY5MyA1Ni42OTMiIGhlaWdodD0iNTYuNjkzcHgiIGlkPSJMYXllcl8xIiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA1Ni42OTMgNTYuNjkzIiB3aWR0aD0iNTYuNjkzcHgiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxwYXRoIGQ9Ik01Mi44MzcsMTUuMDY1Yy0xLjgxMSwwLjgwNS0zLjc2LDEuMzQ4LTUuODA1LDEuNTkxYzIuMDg4LTEuMjUsMy42ODktMy4yMyw0LjQ0NC01LjU5MmMtMS45NTMsMS4xNTktNC4xMTUsMi02LjQxOCwyLjQ1NCAgYy0xLjg0My0xLjk2NC00LjQ3LTMuMTkyLTcuMzc3LTMuMTkyYy01LjU4MSwwLTEwLjEwNiw0LjUyNS0xMC4xMDYsMTAuMTA3YzAsMC43OTEsMC4wODksMS41NjIsMC4yNjIsMi4zMDMgIGMtOC40LTAuNDIyLTE1Ljg0OC00LjQ0NS0yMC44MzMtMTAuNTZjLTAuODcsMS40OTItMS4zNjgsMy4yMjgtMS4zNjgsNS4wODJjMCwzLjUwNiwxLjc4NCw2LjYsNC40OTYsOC40MTIgIGMtMS42NTYtMC4wNTMtMy4yMTUtMC41MDgtNC41NzgtMS4yNjVjLTAuMDAxLDAuMDQyLTAuMDAxLDAuMDg1LTAuMDAxLDAuMTI4YzAsNC44OTYsMy40ODQsOC45OCw4LjEwOCw5LjkxICBjLTAuODQ4LDAuMjMtMS43NDEsMC4zNTQtMi42NjMsMC4zNTRjLTAuNjUyLDAtMS4yODUtMC4wNjMtMS45MDItMC4xODJjMS4yODcsNC4wMTUsNS4wMTksNi45MzgsOS40NDEsNy4wMTkgIGMtMy40NTksMi43MTEtNy44MTYsNC4zMjctMTIuNTUyLDQuMzI3Yy0wLjgxNSwwLTEuNjItMC4wNDgtMi40MTEtMC4xNDJjNC40NzQsMi44NjksOS43ODYsNC41NDEsMTUuNDkzLDQuNTQxICBjMTguNTkxLDAsMjguNzU2LTE1LjQsMjguNzU2LTI4Ljc1NmMwLTAuNDM4LTAuMDA5LTAuODc1LTAuMDI4LTEuMzA5QzQ5Ljc2OSwxOC44NzMsNTEuNDgzLDE3LjA5Miw1Mi44MzcsMTUuMDY1eiIvPjwvc3ZnPg==" aria-hidden="true"/></a>
    

    
	
	
	
	

    
    <a href="https://www.linkedin.com/in/danieleferla" target="_blank"><img alt="linkedin" class="social-icons" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDU2LjY5MyA1Ni42OTMiIGhlaWdodD0iNTYuNjkzcHgiIGlkPSJMYXllcl8xIiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA1Ni42OTMgNTYuNjkzIiB3aWR0aD0iNTYuNjkzcHgiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxnPjxwYXRoIGQ9Ik0zMC4wNzEsMjcuMTAxdi0wLjA3N2MtMC4wMTYsMC4wMjYtMC4wMzMsMC4wNTItMC4wNSwwLjA3N0gzMC4wNzF6Ii8+PHBhdGggZD0iTTQ5LjI2NSw0LjY2N0g3LjE0NWMtMi4wMTYsMC0zLjY1MSwxLjU5Ni0zLjY1MSwzLjU2M3Y0Mi42MTNjMCwxLjk2NiwxLjYzNSwzLjU2MiwzLjY1MSwzLjU2Mmg0Mi4xMiAgIGMyLjAxOSwwLDMuNjU0LTEuNTk3LDMuNjU0LTMuNTYyVjguMjNDNTIuOTE5LDYuMjYyLDUxLjI4Myw0LjY2Nyw0OS4yNjUsNC42Njd6IE0xOC40NzUsNDYuMzA0aC03LjQ2NVYyMy44NDVoNy40NjVWNDYuMzA0eiAgICBNMTQuNzQzLDIwLjc3N2gtMC4wNWMtMi41MDQsMC00LjEyNC0xLjcyNS00LjEyNC0zLjg4YzAtMi4yMDMsMS42Ny0zLjg4LDQuMjIzLTMuODhjMi41NTQsMCw0LjEyNSwxLjY3Nyw0LjE3NSwzLjg4ICAgQzE4Ljk2NywxOS4wNTIsMTcuMzQ1LDIwLjc3NywxNC43NDMsMjAuNzc3eiBNNDUuMzk0LDQ2LjMwNGgtNy40NjVWMzQuMjg2YzAtMy4wMTgtMS4wOC01LjA3OC0zLjc4MS01LjA3OCAgIGMtMi4wNjIsMC0zLjI5LDEuMzg5LTMuODMxLDIuNzMxYy0wLjE5NywwLjQ3OS0wLjI0NSwxLjE0OS0wLjI0NSwxLjgyMXYxMi41NDNoLTcuNDY1YzAsMCwwLjA5OC0yMC4zNTQsMC0yMi40NTloNy40NjV2My4xNzkgICBjMC45OTItMS41MywyLjc2Ni0zLjcwOSw2LjcyOS0zLjcwOWM0LjkxMSwwLDguNTk0LDMuMjExLDguNTk0LDEwLjExVjQ2LjMwNHoiLz48L2c+PC9zdmc+" aria-hidden="true"/></a>
    
	
	
	
	
	
	
	
	

    

    

    

  </div>
  © 2019 Daniele Ferla. All rights reserved.
</div>

  </div>
</body>
</html>
