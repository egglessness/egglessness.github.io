<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
 
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicons/favicon-96x96.png">
  <link rel="manifest" href="/assets/favicons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/favicons/ms-icon-144x144.png">
  <meta name="theme-color" content="#454545">

  <meta name="google-site-verification" content="unVLsLtZ5JXjvkqK1ir5mKJ-VcaC0fIocmj52TdsULg" />
  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" type="text/css" lazyload>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather|Ubuntu+Mono|Lato" rel="stylesheet" lazyload>
  <link rel="alternate" type="application/rss+xml" title="RSS Feed for polycarp - random notes on computer security" href="/feed.xml" />
  <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>No, using strncpy won’t really make you safer | polycarp - random notes on computer security</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="No, using strncpy won’t really make you safer" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Even if specifying the length of the buffer you want to operate on seems a good security practice, using strncpy instead of strcpy may help attackers to leak sensible data from your program memory. Here’s why." />
<meta property="og:description" content="Even if specifying the length of the buffer you want to operate on seems a good security practice, using strncpy instead of strcpy may help attackers to leak sensible data from your program memory. Here’s why." />
<link rel="canonical" href="http://localhost:4000/2019/strncpy-wont-make-you-safer/" />
<meta property="og:url" content="http://localhost:4000/2019/strncpy-wont-make-you-safer/" />
<meta property="og:site_name" content="polycarp - random notes on computer security" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-09T00:00:00+02:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2019/strncpy-wont-make-you-safer/","description":"Even if specifying the length of the buffer you want to operate on seems a good security practice, using strncpy instead of strcpy may help attackers to leak sensible data from your program memory. Here’s why.","headline":"No, using strncpy won’t really make you safer","dateModified":"2019-04-09T00:00:00+02:00","datePublished":"2019-04-09T00:00:00+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019/strncpy-wont-make-you-safer/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  
  <meta name="keywords" content="strncpy, strcpy, c programming, secure programming, buffer overflow, leakage">
  

  

  <!-- Google Analytics -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130789124-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-130789124-1');
</script>




</head>

<body>
  <div class="content-container">
    <header>
  <div class="header-small">
    <a href="http://localhost:4000" target="_self"><img id="logo" src="http://localhost:4000/assets/images/logo.png" alt="logo"></a>
  </div>
  <nav class="header-nav">
    
    
    <a href="/" target="_self">Blog</a>
     &nbsp/&nbsp 
    
    
    
    <a href="/about/" target="_self">About</a>
    
    
    
  </nav>
</header>
<div class="page">
  <base target="_blank">

<div class="post">
  <h1 class="post-title">No, using strncpy won't really make you safer</h1>
  <span class="post-date">
    <time>09 Apr 2019</time>
  </span>
  <div class="post-tag">
    <ul>
      
    </ul>
  </div>

  <p>A common belief among programmers is that functions like <code class="highlighter-rouge">strncpy</code> are more secure than <code class="highlighter-rouge">strcpy</code>, due to the fact that the former accepts the number of bytes to copy, while the latter doesn’t. This allows a developer to pass the size of the destination buffer to <code class="highlighter-rouge">strncpy</code>, avoiding to overflow it in case we’re copying data from a possibly unbounded source.</p>

<p>However, this doens’t mean that <code class="highlighter-rouge">strncpy</code> is <em>always</em> secure. In <a href="https://grsecurity.net/huawei_and_security_analysis.php">this article</a> grsecurity researchers demonstrate that naively grouping APIs in “safe” or “unsafe”  can lead to wrong assumptions, regarding the best function to use.</p>

<p>To start with a basic example, let’s take a look at the following program:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="cp">#define BUF_SIZE 10
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">secret</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"secret string!"</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_SIZE</span><span class="p">];</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">BUF_SIZE</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As we can see, we are diligently using <code class="highlighter-rouge">strncpy</code> instead of <code class="highlighter-rouge">strcpy</code> because our source (<code class="highlighter-rouge">argv[1]</code>) is potentially unbounded, so we copy only <code class="highlighter-rouge">BUF_SIZE</code> bytes from source to destination.</p>

<p>However, if there isn’t a null terminator in the first <code class="highlighter-rouge">BUF_SIZE</code> bytes of <code class="highlighter-rouge">argv[1]</code>, the destination buffer will hold a non-terminated string. The result? An attacker can leak all the stack variables, until a NULL byte is reached.</p>

<p>Let’s test this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./vuln AAAAAA
AAAAAA
$ ./vuln AAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAsecret string!
</code></pre></div></div>

<p>If we pass as argument a string longer than 10 bytes, it will be copied in <code class="highlighter-rouge">buf</code> without the null terminator, leaking our precious secret.</p>

<p>The story on the article is even funnier: once a programmer, wanting to avoid the behaviour above without adding further checks or purposely add a NULL byte at the end of the destination buffer, replaced all the calls for <code class="highlighter-rouge">strncpy</code> in the crypto module of the Linux kernel with <code class="highlighter-rouge">strlcpy</code>.</p>

<p>This function (non-POSIX, but available via <code class="highlighter-rouge">libbsd</code>) is very similar to <code class="highlighter-rouge">strncpy</code>: it takes the same arguments of <code class="highlighter-rouge">strncpy</code>, but always adds a null terminator at the end of the destination buffer.</p>

<p>This substitution solved a problem, but introduced another one. Turns out that, while <code class="highlighter-rouge">strncpy</code> also zero-pads the destination buffer in the case the source is shorter than the destination,  <code class="highlighter-rouge">strlcpy</code> doesn’t. In the latter case, <code class="highlighter-rouge">strlcpy</code> introduced an issue that could lead to information leak, since old data may be present on the destination buffer.</p>

<p>So, what’s the takeaway? Well, there are two actually:</p>

<ol>
  <li>Man pages are your friends. Side-effects and other warnings are always reported in the man page of each function. Take always a look to them!</li>
  <li>Most of the time, a function is not safe/unsafe per se, but it always depends on the context around. Being aware of this can avoid to fall into wrong assumptions.</li>
</ol>




</div>

</div>


    
<div class="footer">
  <hr />
  <div class="footer-link">
    
	
	
	
	

    
    <a href="https://twitter.com/surruskij" target="_blank"><img alt="twitter" class="social-icons" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDU2LjY5MyA1Ni42OTMiIGhlaWdodD0iNTYuNjkzcHgiIGlkPSJMYXllcl8xIiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA1Ni42OTMgNTYuNjkzIiB3aWR0aD0iNTYuNjkzcHgiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxwYXRoIGQ9Ik01Mi44MzcsMTUuMDY1Yy0xLjgxMSwwLjgwNS0zLjc2LDEuMzQ4LTUuODA1LDEuNTkxYzIuMDg4LTEuMjUsMy42ODktMy4yMyw0LjQ0NC01LjU5MmMtMS45NTMsMS4xNTktNC4xMTUsMi02LjQxOCwyLjQ1NCAgYy0xLjg0My0xLjk2NC00LjQ3LTMuMTkyLTcuMzc3LTMuMTkyYy01LjU4MSwwLTEwLjEwNiw0LjUyNS0xMC4xMDYsMTAuMTA3YzAsMC43OTEsMC4wODksMS41NjIsMC4yNjIsMi4zMDMgIGMtOC40LTAuNDIyLTE1Ljg0OC00LjQ0NS0yMC44MzMtMTAuNTZjLTAuODcsMS40OTItMS4zNjgsMy4yMjgtMS4zNjgsNS4wODJjMCwzLjUwNiwxLjc4NCw2LjYsNC40OTYsOC40MTIgIGMtMS42NTYtMC4wNTMtMy4yMTUtMC41MDgtNC41NzgtMS4yNjVjLTAuMDAxLDAuMDQyLTAuMDAxLDAuMDg1LTAuMDAxLDAuMTI4YzAsNC44OTYsMy40ODQsOC45OCw4LjEwOCw5LjkxICBjLTAuODQ4LDAuMjMtMS43NDEsMC4zNTQtMi42NjMsMC4zNTRjLTAuNjUyLDAtMS4yODUtMC4wNjMtMS45MDItMC4xODJjMS4yODcsNC4wMTUsNS4wMTksNi45MzgsOS40NDEsNy4wMTkgIGMtMy40NTksMi43MTEtNy44MTYsNC4zMjctMTIuNTUyLDQuMzI3Yy0wLjgxNSwwLTEuNjItMC4wNDgtMi40MTEtMC4xNDJjNC40NzQsMi44NjksOS43ODYsNC41NDEsMTUuNDkzLDQuNTQxICBjMTguNTkxLDAsMjguNzU2LTE1LjQsMjguNzU2LTI4Ljc1NmMwLTAuNDM4LTAuMDA5LTAuODc1LTAuMDI4LTEuMzA5QzQ5Ljc2OSwxOC44NzMsNTEuNDgzLDE3LjA5Miw1Mi44MzcsMTUuMDY1eiIvPjwvc3ZnPg==" aria-hidden="true"/></a>
    

    
	
	
	
	

    
    <a href="https://www.linkedin.com/in/danieleferla" target="_blank"><img alt="linkedin" class="social-icons" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDU2LjY5MyA1Ni42OTMiIGhlaWdodD0iNTYuNjkzcHgiIGlkPSJMYXllcl8xIiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA1Ni42OTMgNTYuNjkzIiB3aWR0aD0iNTYuNjkzcHgiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxnPjxwYXRoIGQ9Ik0zMC4wNzEsMjcuMTAxdi0wLjA3N2MtMC4wMTYsMC4wMjYtMC4wMzMsMC4wNTItMC4wNSwwLjA3N0gzMC4wNzF6Ii8+PHBhdGggZD0iTTQ5LjI2NSw0LjY2N0g3LjE0NWMtMi4wMTYsMC0zLjY1MSwxLjU5Ni0zLjY1MSwzLjU2M3Y0Mi42MTNjMCwxLjk2NiwxLjYzNSwzLjU2MiwzLjY1MSwzLjU2Mmg0Mi4xMiAgIGMyLjAxOSwwLDMuNjU0LTEuNTk3LDMuNjU0LTMuNTYyVjguMjNDNTIuOTE5LDYuMjYyLDUxLjI4Myw0LjY2Nyw0OS4yNjUsNC42Njd6IE0xOC40NzUsNDYuMzA0aC03LjQ2NVYyMy44NDVoNy40NjVWNDYuMzA0eiAgICBNMTQuNzQzLDIwLjc3N2gtMC4wNWMtMi41MDQsMC00LjEyNC0xLjcyNS00LjEyNC0zLjg4YzAtMi4yMDMsMS42Ny0zLjg4LDQuMjIzLTMuODhjMi41NTQsMCw0LjEyNSwxLjY3Nyw0LjE3NSwzLjg4ICAgQzE4Ljk2NywxOS4wNTIsMTcuMzQ1LDIwLjc3NywxNC43NDMsMjAuNzc3eiBNNDUuMzk0LDQ2LjMwNGgtNy40NjVWMzQuMjg2YzAtMy4wMTgtMS4wOC01LjA3OC0zLjc4MS01LjA3OCAgIGMtMi4wNjIsMC0zLjI5LDEuMzg5LTMuODMxLDIuNzMxYy0wLjE5NywwLjQ3OS0wLjI0NSwxLjE0OS0wLjI0NSwxLjgyMXYxMi41NDNoLTcuNDY1YzAsMCwwLjA5OC0yMC4zNTQsMC0yMi40NTloNy40NjV2My4xNzkgICBjMC45OTItMS41MywyLjc2Ni0zLjcwOSw2LjcyOS0zLjcwOWM0LjkxMSwwLDguNTk0LDMuMjExLDguNTk0LDEwLjExVjQ2LjMwNHoiLz48L2c+PC9zdmc+" aria-hidden="true"/></a>
    
	
	
	
	
	
	
	
	

    

    

    

  </div>
  © 2019 Daniele Ferla. All rights reserved.
</div>

  </div>
</body>
</html>
